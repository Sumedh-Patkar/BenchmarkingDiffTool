{% extends 'base.html' %}

{% block title %}
All Runs of the test
{% endblock title %}


{% block content %}

	<h2 style="font-weight: bold; text-align: center;">{{ context.testname }}</h2>
	
	<div id="outer-graph-div">
		<div id="graph-div">
			<span>
				<select id="yParameter" name="yParameter">
					<!-- TAKING PARAMETERS FROM INI FILE -->
					{% for qualifier in context.qualifier_list %}
						{% if loop.index0 == 0 %}
							<option value="{{ qualifier }}" selected="selected">{{ qualifier }}</option>
						{% else %}
							<option value="{{ qualifier }}">{{ qualifier }}</option>
						{% endif %}
					{% endfor %}
				</select>
				<p>vs</p>
				<select id="xParameter" name="xParameter">
					<option value="Kernel Version" selected="selected">Kernel Version</option>
					<option value="OS Version">OS Version</option>
					<option value="OS Name">OS Name</option>
					<option value="Firmware Version">Firmware Version</option>
					<option value="ToolChain Name">ToolChain Name</option>
					<option value="ToolChain Version">ToolChain Version</option>
					<option value="SMT">SMT</option>
					<option value="Cores">Cores</option>
					<!-- <option value="Corefreq">Corefreq</option> -->
					<option value="DDRfreq">DDRfreq</option>
					<option value="SKUID">SKUID</option>
					<option value="Hostname">Hostname</option>
					<!-- <option value="Flags">Flags</option> -->
				</select>

				<button id="download-comparison-graph" class="blue" onclick="downloadAsPng($('#yParameter option:selected').val() + '-vs-' + $('#xParameter option:selected').val(), 'clustered-graph')">Download as PNG</button>
				
				<button id="download-best-sku-graph-csv" class="blue">Download as CSV</button>
				<button id="download-best-sku-graph" class="blue" onclick="downloadAsPng($('#yParameter option:selected').val() + '-vs-' + $('#xParameter option:selected').val(), 'best-sku-graph')">Download as PNG</button>

			</span>
		</div>
		<div id="graph-plot-div">
			<div id="sku-filters">
				
			</div>
			<div id="clustered-graph"></div>
			<div id="best-sku-graph"></div>
			<form id="graph-type-form">
				<label for="Absolute">Absolute</label>
				<input type="radio" name="typeOfGraph" id="absolute-checkbox" checked="checked" value="Absolute">
				<label for="Normalized">Normalized</label>
				<input type="radio" name="typeOfGraph" id="normalized-checkbox" value="Normalized">
				<select id="normalized-dropdown" name="normalized-dropdown">

				</select>
			</form>
		</div>
		<div id="input-parameters-div">
			<h2 style="font-weight: bold; margin-right: 20px;">Filters</h2>
			{% for column in context.input_details %}
				
				{% set options_list = context.input_details[column] | unique_list %}
			
				<label class = "h4" for="input-parameter-{{column}}">{{column}}</label>
				<select class="input-parameter-select" name="input-parameter-{{column}}" id="input-parameter-{{column}}">
					<option value="None" selected="selected">None</option>
					{% for option in options_list %}
						<option value="option">{{option}}</option>
					{% endfor %}

				</select>
			
			{% endfor %}			
		</div>
	</div>

	<form action="/diff" method="GET">

		<div class='inline-block-child'>
			<table id="allRunsTable">
				<thead>
					<tr>
						<th>Select to Compare</th>
						{% for column in context.data %}

							<th>{{ column }}</th>
						{% endfor %}
					</tr>
				</thead>

				<tbody>
					{% for row in range(context.no_of_rows) %}
						{% set i = loop.index0 %}
						<tr class="table-row">
							{% for key in context.data %}
								{% if loop.index0 == 0%}
									<td><input class="checkbox diff-checkbox" type="checkbox" name="diff-checkbox{{i}}" value="{{ context.data['originID'][i] }}"></td>
									<td class="originID table-cell"><a href="/test-details/{{ context.data[key][i] }}">{{ context.data[key][i] }}</a></td>
								{% else %}
									<td class="table-cell"> {{ context.data[key][i] }}</td>
								{% endif %}
							{% endfor %}
						</tr>
					{% endfor %}
				</tbody>
			</table>
			<button type="button" id="download-all-results-table-csv" class="blue">Download as CSV</button>
		</div>
		
	</form>

	<!-- Hidden form for Downloading data as CSV -->
	<form action="/download_as_csv" method="POST" id="download-csv-form" style="display:none;">
	</form>

<script>
	uncheckBoxes("diff-checkbox");
	
	document.getElementById("graph-type-form").reset();
	var $normalizedList = $("#normalized-dropdown");
	$normalizedList.hide();

	$(document).ready(function() {
	    // Setup - append a text input to each header cell
	    $('#allRunsTable thead tr').clone(true).appendTo( '#allRunsTable thead' );
	    $('#allRunsTable thead tr:eq(1) th').each( function (i) {
	    	if(i == 0)
	    		$(this).html( '<button id="diff-button" class="blue" type="submit">Compare</button>' );
	    	else
	        {
	        	var title = $(this).text();
	        	$(this).html( '<input type="text" placeholder="Search '+title+'" />' );
	        }
	 
	        $( 'input', this ).on( 'keyup change', function () {
	            if ( table.column(i).search() !== this.value ) {
	                table
	                    .column(i)
	                    .search( this.value )
	                    .draw();
	            }
	        });
	    } );
	 
	    var table = $('#allRunsTable').DataTable( {
	    	"lengthMenu": [[10, 25, 50, -1], [10, 25, 50, "All"]],
	        orderCellsTop: true,
	        fixedHeader: true
	    });

	    // ajaxData is the object which is used to send data to the AJAX request
	    ajaxData = {}

	    //draw the first graph according to the selected values
		ajaxData.xParameter = $("#xParameter option:selected").val();
		ajaxData.yParameter = $("#yParameter option:selected").val();
		ajaxData.testname = "{{ context.testname }}"

		// Get the initial input filters list
		inputFiltersList = []
		$allInputFilters = $('.input-parameter-select')

		jQuery.each($allInputFilters, (index, value) => {
		    filter = $('option:selected', value)[0].innerHTML
		    inputFiltersList.push(filter)
		})

		ajaxData.inputFiltersList = inputFiltersList

	    //Function for drawing INITIAL comparison graph
	    sendAjaxRequest(ajaxData, url='/get_data_for_graph')

		// AJAX request to get_data_for_graph for redrawing the graph on "xParameter" changed event
		$(function(){
			$("#xParameter").change(function(){
				//update the xParameter value
				ajaxData.xParameter = $('option:selected', this).text()

				sendAjaxRequest(ajaxData, url='/get_data_for_graph')
			})
		});


		// AJAX request to get_data_for_graph for redrawing the graph on "xParameter" changed event
		$(function(){
			$("#yParameter").change(function(){
				//update the yParameter value
				ajaxData.yParameter = $('option:selected', this).text()
				
				sendAjaxRequest(ajaxData, url='/get_data_for_graph')
			})
		});

	    //Function for drawing Best SKU graph
	    bestSkuAjaxData = {'xParameter': 'SKUs', 'yParameter': "", 'testname' : "{{ context.testname }}"}
	    bestSkuAjaxData.inputFiltersList = inputFiltersList
	    sendAjaxRequest(bestSkuAjaxData, url='/best_sku_graph')

	    //fill the dropdown list
	    //and hide it
	    fillNormalizedDropdown();

	    //Event handler on switching from "Absolute" to "Normalized" best_sku_graph and vice-versa
		$('input[type=radio][name=typeOfGraph]').change(function() {
		    if (this.value == 'Absolute') {
		    	var $normalizedList = $("#normalized-dropdown");
		    	$normalizedList.hide();
		    	sendAjaxRequest(bestSkuAjaxData, url='/best_sku_graph')
		        
		    }
		    else if (this.value == 'Normalized') {
		    	var $normalizedList = $("#normalized-dropdown");
		    	$normalizedList.show();

		    	drawNormalizedGraph('best-sku-graph', "{{ context.testname }}")
		        
		    }
		});

		$(function(){
			$("#normalized-dropdown").change(function(){

				drawNormalizedGraph('best-sku-graph', "{{ context.testname }}", inverseApplied = true)
			})
		});

	});

	$('#download-best-sku-graph-csv').click(function(){

		data = {
			'x': [],
			'y': [],
		}

		$bestSkuGraph = $('#best-sku-graph')

		for(i = 0; i < $bestSkuGraph[0].data.length; i++){
			data['x'].push(...$bestSkuGraph[0].data[i].x)
			data['y'].push(...$bestSkuGraph[0].data[i].y)
		}

		console.log("DATA")
		console.log(data)

		$form = $('#download-csv-form')

		downloadAsCsv($('#yParameter option:selected').val() +'-vs-'+ $('#xParameter option:selected').val(), data, $form)
	})

	$('#download-all-results-table-csv').click(function(){

		filename = "{{context.testname}}"

		data = {

		}

		$tableRows = $("#allRunsTable th")
		$table = $("#allRunsTable").DataTable()
		$allColumnsData = $table.columns({ filter : 'applied'}).data()

		for( i = 1; i < $tableRows.length/2; i++){
  			column = $tableRows[i].innerHTML

  			console.log(column)
  			if(i == 1)
  				data[column] = jQuery.map($allColumnsData[i], function( value, index ) {
									return jQuery(value).text()
  								});
  			else
  				data[column] = $allColumnsData[i]
  		}


		console.log("DATA")
		console.log(data)

		$form = $('#download-csv-form')

		downloadAsCsv(filename, data, $form)
	})

	$('.input-parameter-select').change(function(){
		
		inputFiltersList = []
		$allInputFilters = $('.input-parameter-select')

		jQuery.each($allInputFilters, (index, value) => {
		    filter = $('option:selected', value)[0].innerHTML
		    inputFiltersList.push(filter)
		})

		ajaxData.inputFiltersList = inputFiltersList
		sendAjaxRequest(ajaxData, url='/get_data_for_graph')
	
		bestSkuAjaxData.inputFiltersList = inputFiltersList
		sendAjaxRequest(bestSkuAjaxData, url='/best_sku_graph')

	})


</script>
	

{% endblock content %}